openapi: 3.0.3
info:
  title: WASAText
  description: |
    API for the WASAText application, which is the project for the WASA course @ Sapienza
  version: 0.0.1

tags:
  - name: Chats
    description: Operations involving chats
  - name: Chat management
    description: Operations involving chats
  - name: Login
    description: Login operations
  - name: User operations
    description: Operations that users can perform
  - name: Settings
    description: Operations involving settings

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    user_id:
      name: user_id
      description: |
        ID of the user
      in: path
      required: true
      schema:
        type: integer
        minimum: 1
        maximum: 2048
    
    chat_id:
      name: chat_id
      description: |
        ID of the chat
      in: path
      required: true
      schema:
        type: integer
        minimum: 1
        maximum: 65536
    
    message_id:
      name: message_id
      description: |
        ID of the message
      in: path
      required: true
      schema:
        type: integer
        minimum: 1
        maximum: 4294967296

    comment_id:
      name: comment_id
      description: |
        ID of the comment
      in: path
      required: true
      schema:
        type: integer
        minimum: 1
        maximum: 4294967296
    
  schemas:
    User:
      title: User
      description: |
        Schema defining a user, which can belong to multiple chats and send messages
      type: object
      properties:
        id:
          description: ID of the message
          type: integer
          example: 1
          minimum: 1
          maximum: 2048 # Had to set a cap on the user ID
        name:
          description: Name of the user
          type: string
          pattern: '^.*?$'
          minLength: 3
          maxLength: 16
          example: Maria
        biography:
          description: |
            Little biography of the user
          type: string
          pattern: '^.*$'
          minLength: 1
          maxLength: 512
          example: When life gives you lemons...
        profilePic:
          description: Profile picture
          type: string
          pattern: '^.*$'
          minLength: 0
          maxLength: 44294967296
          format: byte
      required:
        - id
        - name
        - biography
        - profilePic

    Message:
      title: Message
      description: |
        Representation of a message
      type: object
      properties:
        id:
          description: ID of the message, always expressed in 16 digits
          type: integer
          example: 1
          minimum: 1
          maximum: 1048576 # Could be lower or higher, had to set a maximum
        sender:
          description: ID of the sender
          type: integer
          example: 2
          minimum: 1
          maximum: 2048
        content:
          description: Text of the message
          type: string
          pattern: '^.*$'
          minLength: 1
          maxLength: 65536
          example: Lorem ipsum dolor sit est cum magna gratia
        timestamp:
          description: Timestamp of when the message was sent
          type: string
          # format: date-time
          pattern: '^[0-9]*$'
          minLength: 0
          maxLength: 44294967296
          example: '1731321854'
        photo:
          description: Photo sent with the message, if any is sent. Can be null
          type: string
          format: byte
          pattern: '^.*$'
          minLength: 0
          maxLength: 44294967296
        received:
          description: List of users who received the message
          type: array
          minItems: 0
          maxItems: 44294967296
          items:
            $ref: "#/components/schemas/User"
        read:
          description: List of users who read the message
          type: array
          minItems: 0
          maxItems: 44294967296
          items:
            $ref: "#/components/schemas/User"
        deleted:
          description: Whether the message has been deleted
          type: boolean
        forwarded:
          description: Specifies whether the message was forwarded
          type: boolean
          example: false
        reactions:
          description: Set of reactions applied to the message
          type: array
          minItems: 0
          maxItems: 44294967296
          items:
            $ref: "#/components/schemas/Reaction"
      required:
        - id
        - sender
        - content
        - timestamp
        - photo
        - received
        - read
        - deleted
        - forwarded
        - reactions

    Reaction:
      title: Reaction
      description: |
        Defines a reaction, which can be made out of text or an emoji
      type: object
      properties:
        id:
          description: ID of the reaction
          type: integer
          example: 3
          minimum: 1
          maximum: 1048576
        message:
          description: Message ID to which the reaction corresponds
          type: integer
          example: 2
          minimum: 1
          maximum: 1048576
        sender:
          description: ID of the sending user
          type: integer
          example: 5
          minimum: 1
          maximum: 2048
        content:
          description: Content of the reaction
          type: string
          pattern: '^.*$'
          minLength: 1
          maxLength: 16384
      required:
        - id
        - message
        - sender
        - content

    Chat:
      title: Chat
      description: Representation of a chat
      type: object
      properties:
        id:
          description: ID of the chat
          type: integer
          example: 4
          minimum: 1
          maximum: 65536 # Set to 65536 for convenience, could be higher / lower
        isPrivate:
          description: Defines whether the chat is private or is a group (if true, the chat is private; if false, the chat is a group)
          type: boolean
          example: true
        users:
          description: List of users participating to the chat
          type: array
          items:
            description: ID of the users
            type: integer
            minimum: 1
            maximum: 2048
          minItems: 0
          maxItems: 4294967296
        name:
          description: Name of the group chat. Visible only if the chat is a group
          type: string
          pattern: '^.*$'
          minLength: 0
          maxLength: 4294967296
          example: The children of Andrew
        groupDescription:
          description: Description of the group. Visible only if the chat is a group
          type: string
          example: We are such a nice group!
          pattern: '^.*$'
          minLength: 0
          maxLength: 65536
        photo:
          description: Profile picture of the chat. Visible only if the chat is a group
          type: string
          format: byte
          pattern: '^.*$'
          minLength: 0
          maxLength: 4294967296
        messages:
          description: List of all the messages sent in the chat
          type: array
          minItems: 0
          maxItems: 4294967296
          items:
            $ref: "#/components/schemas/Message"
        lastSent:
          description: ID of the last sent message
          type: integer
          example: 2
          minimum: 1
          maximum: 4294967296
      required:
        - id
        - isPrivate
        - users
        - name
        - groupDescription
        - photo
        - messages
        - lastSent
  
security:
  - bearerAuth: []


paths:
  /session:
    # POST = doLogin
    post:
      tags: ["User operations", "Login"]
      summary: Logs in the user
      description: |
        If the user does not exist, it will be created,
        and an identifier is returned.
        If the user exists, the user identifier is returned.
      operationId: doLogin
      requestBody:
        description: User details
        content:
          application/json:
            schema:
              type: object
              description: JSON object representing the user
              properties:
                name:
                  type: string
                  description: Name of the user
                  example: Maria
                  pattern: '^.*?$'
                  minLength: 3
                  maxLength: 16
        required: true
      
      responses:
        '200':
          description: |
            User log-in action successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        
        '201':
          description: |
            The user does not exist, hence it will be created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        
        '403':
          description: |
            The user is already logged in
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
  
  /user/{user_id}/chats:
    # GET = getMyConversations
    parameters:
      - $ref: "#/components/parameters/user_id"

    get:
      tags: ["User operations", "Chats"]
      summary: Get the chats of the user
      description: Get the chats of the user specified in the user ID
      operationId: getMyConversations
      responses:
        "200":
          description: |
            Successfully retrieven the chats of the user
          content:
            application/json:
              schema:
                type: object
                description: Object containing an array of chats to which the user belongs
                properties:
                  userChats:
                    type: array
                    description: Array containing the chats to which the user belongs
                    items: 
                      $ref: "#/components/schemas/Chat"
                    minItems: 0
                    maxItems: 4294967296
                required: 
                  - userChats
        
        '404':
          description: |
            The chat does not exist
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Chat"
  
  /user/{user_id}/name:
    # POST = setMyUserName
    parameters:
      - $ref: "#/components/parameters/user_id"

    post:
      tags: ["User operations", "Settings"]
      summary: Change the username of the user
      description: Changes the username of the user specified by the ID in the path
      operationId: setMyUserName
      requestBody:
        description: New username
        content:
          application/json:
            schema:
              type: object
              description: Object containing the new username of the user
              properties:
                newUsername:
                  type: string
                  description: New username
                  pattern: '^.*?$'
                  minLength: 3
                  maxLength: 16
                  example: Maria
        required: true
      responses:
        "204":
          description: |
            The username has been changed successfully
        "418":
          description: |
            The username wasn't changed due to an error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"

  /user/{user_id}/photo:
    # POST = setMyPhoto
    parameters:
      - $ref: "#/components/parameters/user_id"

    post:
      tags: ["User operations"]
      summary: Changes the user's photo
      operationId: setMyPhoto
      description: Changes the user's photo
      requestBody:
        description: The new photo of the user
        content:
          application/json:
            schema:
              type: object
              description: Object containing the new photo of the user
              properties:
                newPhoto:
                  type: string
                  description: The new photo of the user
                  minLength: 0
                  maxLength: 4294967296
                  pattern: '^.*$'
                  format: byte
        required: true
      responses:
        "204":
          description: |
            The photo ahs been changed successfully
        
        '403':
          description: |
            You are not the user, you can't change someone else's photo
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"

  /user/{user_id}/bio:
    # POST = setMyBio
    parameters:
      - $ref: "#/components/parameters/user_id"
    
    post:
      tags: ["User operations", "Settings"]
      summary: Change the bio of the user
      operationId: setMyBio
      description: Change the bio of the user
      requestBody:
        description: The new biography
        content:
          application/json:
            schema:
              description: Object containing the new bio of the user
              type: object
              properties:
                newBio:
                  type: string
                  description: The new bio of the user
                  pattern: '^.*$'
                  minLength: 1
                  maxLength: 2048
        required: true
      responses:
        "204":
          description: |
            The biography has been changed successfully

        '403':
          description: |
            You are not the user, you can't change someone else's bio
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"

  /chat/{chat_id}:
    # GET = getConversation
    # PUT = createConversation
    # POST = leaveGroup
    parameters:
      - $ref: "#/components/parameters/chat_id"

    get:
      tags: ["User operations", "Chats"]
      summary: Get the chat
      description: Get the chat determined by the ID in the path
      operationId: getConversation
      responses:
        '200':
          description: Chat successfully retrieven
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Chat"
        
        '404':
          description: |
            The chat does not exist
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Chat"

    put:
      tags: ["Chats", "Chat management"]
      summary: Create a conversation
      description: Creates a conversation, which may be either a group or a private chat
      operationId: createConversation
      requestBody:
        description: |
          The chat that must be created
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Chat"
        required: true
      responses:
        '201':
          description: Conversation successfully created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Chat"
        
        '408':
          description: |
            There has been an error while trying to create the chat
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Chat"

    delete:
      tags: ["Chats", "Chat management"]
      summary: Leave the group
      operationId: leaveGroup
      description: Leave the group
      responses:
        "204":
          description: |
            The user left the group successfully

        '408':
          description: |
            There was an error while trying to leave the chat
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Chat"

  /chat/{chat_id}/users:
    parameters:
      - $ref: "#/components/parameters/chat_id"
    # POST = addToGroup

    post:
      tags: ["Chats"]
      summary: Add user to group
      operationId: addToGroup
      description: Adds a user to a group
      requestBody:
        description: |
          User to be added to the group
        content:
          application/json:
            schema:
              type: object
              description: Object containing the username of the user that must be added
              properties:
                newUsername:
                  type: string
                  description: User to be added
                  pattern: '^.*?$'
                  minLength: 3
                  maxLength: 16
                  example: Marco
        required: true
      responses:
        "200":
          description: |
            The user has been added to the group
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Chat"

        '404':
          description: |
            The user does not exist
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"

  /chat/{chat_id}/name:
    parameters:
        - $ref: "#/components/parameters/chat_id"
    # POST = setGroupName
    
    post:
      tags: ["Chats", "Chat management"]
      summary: Set the name of the group
      operationId: setGroupName
      description: Set the name of the group
      requestBody:
        description: The name of the group
        content:
          application/json:
            schema:
              type: object
              description: New name of the group, as a string whose length must be smaller than 4096 characters
              properties:
                newName:
                  type: string
                  description: New name of the group
                  pattern: '^.*$'
                  minLength: 1
                  maxLength: 4096
                  example: The new fantastic four
        required: true
      responses:
        "204":
          description: |
            The group name has been changed successfully
        
        '408':
          description: |
            There has been an error while trying to update the group name. Perhaps this is a private chat?
          content:
            application/json:
              schema:
                type: object
                description: New name of the group
                properties:
                  newName:
                    type: string
                    description: New name of the group
                    pattern: '^.*$'
                    minLength: 1
                    maxLength: 4096
                    example: The new fantastic four

  /chat/{chat_id}/photo:
    parameters:
      - $ref: "#/components/parameters/chat_id"
    # POST = setGroupPhoto
    
    post:
      tags: ["Chats", "Chat management"]
      summary: Change the photo of the group
      operationId: setGroupPhoto
      description: Change the photo of the group
      requestBody:
        description: The new photo of the group
        content:
          application/json:
            schema:
              type: object
              description: New photo of the group
              properties:
                newPhoto:
                  type: string
                  format: byte
                  pattern: '^.*$'
                  description: New photo of the group, as a string
                  minLength: 0
                  maxLength: 4294967296
        required: true
      responses:
        "204":
          description: |
            The photo of the group has been changed successfully

        '408':
          description: |
            There has been an error while trying to update the chat photo. Perhaps this is a private chat?
          content:
            application/json:
              schema:
                type: object
                description: New photo of the group
                properties:
                  newPhoto:
                    type: string
                    format: byte
                    pattern: '^.*$'
                    description: New photo of the group, as a string
                    minLength: 0
                    maxLength: 4294967296

  /chat/{chat_id}/description:
    parameters:
    - $ref: "#/components/parameters/chat_id"
    # POST = setGroupDescription
    
    post:
      tags: ["Chats", "Chat management"]
      summary: Change the description of the group
      operationId: setGroupDescription
      description: Change the description of the group
      requestBody:
        description: The new description of the group
        content:
          application/json:
            schema:
              type: object
              description: New description of the group
              properties:
                newDescription:
                  type: string
                  minLength: 0
                  maxLength: 4098
                  pattern: '^.*$'
                  description: Description of the group. New lines aren't allowed
                  example: A new group! How cool!
        required: true
      responses:
        "204":
          description: |
            The description of the group has been changed successfully

        '408':
          description: |
            There has been an error while trying to update the chat description. Perhaps this is a private chat?
          content:
            application/json:
              schema:
                type: object
                description: New description of the group
                properties:
                  newDescription:
                    type: string
                    minLength: 0
                    maxLength: 4098
                    pattern: '^.*$'
                    description: Description of the group. New lines aren't allowed
                    example: A new group! How cool!

  /message/{message_id}:
    parameters:
      - $ref: "#/components/parameters/message_id"
    # PUT = sendMessage
    # DELETE = deleteMessage
    # POST = forwardMessage

    put:
      tags: ["Chats"]
      summary: Send a message to the chat
      operationId: sendMessage
      description: Sends a message to the chat given the messageId
      requestBody:
        description: The message that must be sent
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Message"
        required: true
      responses:
        "200":
          description: |
            The message has been sent successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Message"

        "418":
          description: |
            Couldn't send the message
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Message"

    delete:
      tags: ["Chats"]
      summary: Delete a message from the chat
      operationId: deleteMessage
      description: Deletes a message from the chat, given the messageId
      responses:
        "204":
          description: |
            The message has been deleted successfully

        "408":
          description: |
            Couldn't delete the message
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Message"

    post:
      tags: ["Chats"]
      summary: Forward a message to another chat
      description: Allows to forward a message to another chat
      operationId: forwardMessage
      requestBody:
        description: The chat to which the message should be forwarded
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Chat"
        required: true
      responses:
        "204":
          description: |
            The message has been forwarded to the chat

        "403":
          description: |
            Can't forward to another chat. Are you part of it?
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Message"

  /comment/{comment_id}:
    parameters:
      - $ref: "#/components/parameters/comment_id"
    # POST = commentMessage
    # DELETE = uncommentMessage

    post:
      tags: ["Chats"]
      summary: Comment a message
      operationId: commentMessage
      description: Comments a message, given a messageId
      requestBody:
        description: The comment to add
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Reaction"
        required: true
      responses:
        "204":
          description: |
            The comment has been added successfully

        "408":
          description: |
            There was an error while trying to add a reaction
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Reaction"

    delete:
      tags: ["Chats"]
      summary: Remove a comment from a message
      description: Removes a comment from a message, given the commentId
      operationId: uncommentMessage
      responses:
        "204":
          description: |
            The reaction has been removed successfully

        "403":
          description: |
            Couldn't delete the reaction. Are you part of the chat?
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Reaction"